<!DOCTYPE html>
<html>
 <head>
  <title>Render trace visualizer</title>
  <script>
    function log(x) {
        if (console) {
            console.log(x);
        }
    }

    renderData = new Array();
    currentFrame = 0;
    playing = false;
    timerId = 0;

    function loadData() {
        stop();
        renderData = new Array();
        currentFrame = 0;
        var data = document.getElementById('trace').value.split(/(\r|\n)/);
        for (var i = 0; i < data.length; i++) {
            if (! /RENDERTRACE/.test(data[i])) {
                continue;
            }

            var values = data[i].split(/\s+/);

            // 16 == 1 "RENDERTRACE" + 1 (timestamp) + 4 (viewport) + 4 (displayport) + 4 (drawarea) + 2 (velocity)
            var j = values.length - 16;

            if (j < 0 || values[j] != "RENDERTRACE") {
                log("Error parsing line: " + data[i]);
                continue;
            }
            renderData.push({
                timestamp: values[j+1],
                rects: {
                    "green": {
                        x: parseFloat(values[j+2]),
                        y: parseFloat(values[j+3]),
                        width: parseFloat(values[j+4]),
                        height: parseFloat(values[j+5])
                    },
                    "blue": {
                        x: parseFloat(values[j+6]),
                        y: parseFloat(values[j+7]),
                        width: parseFloat(values[j+8]),
                        height: parseFloat(values[j+9])
                    },
                    "red": {
                        x: parseFloat(values[j+10]),
                        y: parseFloat(values[j+11]),
                        width: parseFloat(values[j+12]),
                        height: parseFloat(values[j+13])
                    }
                },
                vectors: {
                    "green": {
                        x: parseFloat(values[j+14]),
                        y: parseFloat(values[j+15])
                    }
                }
            });
        }

        if (! renderFrame()) {
            alert("No data found; nothing to render!");
        }
    }

    function renderFrame() {
        var frame = currentFrame;
        if (frame < 0 || frame >= renderData.length) {
            log("Invalid frame index");
            return false;
        }

        var canvas = document.getElementById('canvas');
        if (! canvas.getContext) {
            log("No canvas context");
        }

        var context = canvas.getContext('2d');

        var minX = undefined;
        var minY = undefined;
        var maxX = undefined;
        var maxY = undefined;
        for (i in renderData[frame].rects) {
            var rect = renderData[frame].rects[i];
            if (typeof minX == "undefined") {
                minX = rect.x;
                minY = rect.y;
                maxX = rect.x + rect.width;
                maxY = rect.y + rect.height;
            } else {
                minX = Math.min(minX, rect.x);
                minY = Math.min(minY, rect.y);
                maxX = Math.max(maxX, rect.x + rect.width);
                maxY = Math.max(maxY, rect.y + rect.height);
            }
        }
        var midX = (minX + maxX) / 2.0;
        var midY = (minY + maxY) / 2.0;

        var cmx = canvas.width / 2.0;
        var cmy = canvas.height / 2.0;
        var scale = Math.min(cmx / (maxX - minX), cmy / (maxY - minY));

        function projectX(value) {
            return cmx + ((value - midX) * scale);
        }

        function projectY(value) {
            return cmy + ((value - midY) * scale);
        }

        function drawRect(color, rect) {
            context.strokeStyle = color;
            context.strokeRect(
                projectX(rect.x),
                projectY(rect.y),
                rect.width * scale,
                rect.height * scale);
        }

        function drawLine(color, vector) {
            var baseRect = renderData[frame].rects[color];
            if (typeof baseRect == "undefined") {
                return;
            }
            var baseMidX = baseRect.x + (baseRect.width / 2.0);
            var baseMidY = baseRect.y + (baseRect.height / 2.0);
            var magnitude = Math.sqrt(vector.x * vector.x + vector.y * vector.y);
            var dscale = 30.0 / magnitude;
            context.strokeStyle = color;
            context.beginPath();
            context.moveTo(projectX(baseMidX), projectY(baseMidY));
            context.lineTo(projectX(baseMidX) + (vector.x * dscale), projectY(baseMidY) + (vector.y * dscale));
            context.stroke();
            context.closePath();
        }

        context.fillStyle = 'white';
        context.fillRect(0, 0, canvas.width, canvas.height);
        for (i in renderData[frame].rects) {
            drawRect(i, renderData[frame].rects[i]);
        }
        for (i in renderData[frame].vectors) {
            drawLine(i, renderData[frame].vectors[i]);
        }
        context.fillStyle = 'black';
        context.fillText((frame + 1) + "/" + renderData.length + ": " + renderData[frame].timestamp, 5, 15);

        return true;
    }

    function reset(beginning) {
        currentFrame = (beginning ? 0 : renderData.length);
        renderFrame();
    }

    function step(backwards) {
        if (playing) {
            togglePlay();
        }
        currentFrame += (backwards ? -1 : 1);
        if (! renderFrame()) {
            currentFrame -= (backwards ? -1 : 1);
        }
    }

    function togglePlay() {
        if (playing) {
            clearInterval(timerId);
            playing = false;
        } else {
            timerId = setInterval(function() {
                currentFrame++;
                if (! renderFrame()) {
                    currentFrame--;
                    togglePlay();
                }
            }, 50);
            playing = true;
        }
    }

    function stop() {
        if (playing) {
            togglePlay();
        }
        currentFrame = 0;
        renderFrame();
    }
  </script>
 </head>
 <body>
  <textarea id="trace" rows="10" style="width: 800px"></textarea>
  <div style="width: 800px">
   <button onclick="loadData()" style="float: right">Reload data</button>
   <div style="text-align: center">
    <button onclick="reset(true)">&laquo;</button>
    <button onclick="step(true)">&lt;</button>
    <button onclick="togglePlay()">|| &#9654;</button>
    <button onclick="stop()">&#9744;</button>
    <button onclick="step(false)">&gt;</button>
    <button onclick="reset(false)">&raquo;</button>
   </div>
  </div>
  <canvas id="canvas" width="800" height="600" style="border: solid 1px black">Canvas not supported!</canvas>
 </body>
</html>
